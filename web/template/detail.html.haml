%title
  = "Question Detail - Stack Overflow Clone"
%div.question
  %div.title
    = title
  %button{class="update-button btn btn-primary" data-toggle="modal" data-target="#update-modal" data-name="title"}
    = "Edit"
  %div.author
    = "Question by " <> author
  %div.body
    = body
  %button{type="button" class="update-button btn btn-primary" data-toggle="modal" data-target="#update-modal" data-name="body"}
    = "Edit"
  %button{type="button" class="create-button btn btn-primary" data-toggle="modal" data-target="#update-modal" data-name="answers"}
    = "Answer"
  %button{type="button" class="create-button btn btn-primary" data-toggle="modal" data-target="#update-modal" data-name="comments"}
    = "Comment"
- for %{"index" => comment_index, "author" => author, "body" => body} <- comments do
  %div.comment
    %div.author
      = "Comment by " <> author
    %div.body
      = body
    %button{type="button" class="update-button btn btn-primary" data-toggle="modal" data-target="#update-modal" data-name="comments.#{comment_index}.body"}
      = "Edit"
- for %{"index" => answer_index, "author" => author, "body" => body, "comments" => answer_comments} <- answers do
  %div.answer
    %div.author
      = "Answer by " <> author
    %div.body
      = body
    %button{type="button" class="update-button btn btn-primary" data-toggle="modal" data-target="#update-modal" data-name="answers.#{answer_index}.body"}
      = "Edit"
    %button{type="button" class="create-button btn btn-primary" data-toggle="modal" data-target="#update-modal" data-name="answers.#{answer_index}.comments"}
      = "Comment"
  - for %{"index" => comment_index, "author" => author, "body" => body} <- answer_comments do
    %div.comment
      %div.author
        = "Comment by " <> author
      %div.body
        = body
      %button{type="button" class="update-button btn btn-primary" data-toggle="modal" data-target="#update-modal" data-name="answers.#{answer_index}.comments.#{comment_index}.body"}
        = "Edit"
%form#update-form{action="/v1/question/#{question_id}" method="PUT"}
  %input#operator{ type="hidden" name="operator" value="temp" }
  %input#key{ type="hidden" name="key" value="temp" }
  %div#update-modal{class="modal fade" tabid="-1"}
    %div{class="modal-dialog"}
      %div{class="modal-content"}
        %div{class="modal-header"}
          %h5{class="modal-title"}
            = "Edit"
          %button{type="button" class="close" data-dismiss="modal" aria-label="Close"}
            %span{aria-hidden="true"}
              = "X"
        %div{class="modal-body"}
          %div{class="form-group"}
            %input#value{class="form-control" name="value" value="" rows="10" required}
        %div{class="modal-footer"}
          %button#submit{type="submit" class="submit btn btn-primary"}
            = "Confirm"
          %button{type="cancel" class="btn btn-secondary" data-dismiss="modal"}
            = "Close"
%script
  $('.create-button').click(function(){
    $('#operator').val('$push');
    $('#key').val($(this).attr('data-name'));
    $('#value').val('');
    $('#value').attr('hidden', false);
    $('.modal-title').text($(this).text());
  });
  $('.update-button').click(function(){
    $('#operator').val('$set');
    $('#key').val($(this).attr('data-name'));
    $('#value').val($(this).prev().text().trim());
    $('#value').attr('hidden', false);
    $('.modal-title').text($(this).text());
  });
  $('#update-form').submit(function(event) {
    event.preventDefault();
    $.ajax({
      url: '/v1'+location.pathname,
      type: 'PUT',
      data: $('#update-form').serialize(),
      timeout: 10000,
      success: function(response){
        window.location.reload();
      }
    });
  });
